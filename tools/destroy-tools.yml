---
- name: Uninstall infrastructure tools
  hosts: localhost
  tasks:
  - name: Update kubeconfig for cluster
    community.digitalocean.digital_ocean_kubernetes_info:
      oauth_token: "{{ lookup('ansible.builtin.env', 'DO_API_TOKEN') }}"
      name: "{{ cluster_name }}"
      return_kubeconfig: yes
    register: doks
  - name: Write kubeconfig to file
    copy:
      content: "{{ doks.data.kubeconfig }}"
      dest: "{{ kubeconfig_path }}"
      mode: 0600
  - name: Uninstall external-dns helm chart
    kubernetes.core.helm:
      kubeconfig_path: "{{ kubeconfig_path }}"
      state: absent
      release_name: external-dns
      release_namespace: external-dns
  - name: Uninstall cert-manager helm chart
    kubernetes.core.helm:
      kubeconfig_path: "{{ kubeconfig_path }}"
      state: absent
      release_name: cert-manager
      release_namespace: cert-manager
  - name: Uninstall ingress-nginx helm chart
    kubernetes.core.helm:
      kubeconfig_path: "{{ kubeconfig_path }}"
      state: absent
      release_name: ingress-nginx
      release_namespace: ingress-nginx
  - name: Uninstall argocd helm chart
    kubernetes.core.helm:
      kubeconfig_path: "{{ kubeconfig_path }}"
      state: absent
      release_name: argocd
      release_namespace: argocd
